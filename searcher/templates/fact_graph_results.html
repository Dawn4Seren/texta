<style>
	.graphBody {
		overflow: hidden;
		margin: 0;
	}

	.countSlider {
		padding-left: 1%;
		padding-right: 1%;
	}

	#countSliderId {
		-webkit-appearance: none;
		width: 100%;
		height: 25px;
		outline: none;
		opacity: 0.7;
		-webkit-transition: .2s;
		transition: opacity .2s;
	}

	#countSliderId:hover {
		opacity: 1;
	}

	}
</style>
<div class="graphBody">
	<div class="countSlider">
		<p> Hide facts with lower count than:</p>
		<input id="countSlider" data-slider-id='countSliderId' type="text" data-slider-min="{{min_node_size}}" data-slider-max="{{max_node_size}}"
		 data-slider-step="1" data-slider-value="0" />

		<script>
			$('#countSlider').slider({
				formatter: function (value) {
					return 'Current value: ' + value;
				}
			});
		</script>
	</div>
</div>

<script>

	Math.clip = function (number, min, max) {
		return Math.max(min, Math.min(number, max));
	}

	var w = window.innerWidth;
	var h = window.innerHeight;

	var factNames = {{ fact_names| safe}}
	var factNamesShow = {}

	for (var i = 0; i < factNames.length; i++) {
		factNamesShow[factNames[i]] = true;
	}

	var focus_node = null, highlight_node = null;

	var text_center = false;
	var outline = false;

	var min_score = 0;
	var max_score = 1;

	var colors = ["#f0f20a", "#f90a0a", "#1d2bec", "#22d012", "#f9a70d", "#ff9292"];
	var shapes = d3.svg.symbolTypes;
	var shapesColors = shapes.reduce((obj, k, i) => ({ ...obj, [k]: colors[i] }), {});

	var color = d3.scale.ordinal()
		.domain(shapes)
		.range(colors);

	var highlight_color = "blue";
	var highlight_trans = 0.1;


	var default_node_color = "#ccc";
	var default_link_color = "#efefef";
	var nominal_base_node_size = 8;
	var nominal_text_size = 10;
	var max_text_size = 24;
	var nominal_stroke = 1;
	var max_stroke = 10;
	var max_base_node_size = 36;
	var min_zoom = 0.1;
	var max_zoom = 7;
	var svg = d3.select(".graphBody").append("svg");
	var zoom = d3.behavior.zoom().scaleExtent([min_zoom, max_zoom])
	var g = svg.append("g");
	svg.style("cursor", "move");

	var size = d3.scale.pow().exponent(1)
		.domain([1, {{ max_node_size }}])
		.range([3, 70]);

	var link_size = d3.scale.pow().exponent(1)
		.domain([1, {{ max_link_size }}])
		.range([nominal_stroke, max_stroke]);

	var force = d3.layout.force()
		.linkDistance(250)
		.charge(-3000)
		.size([w, h]);

	var menu = [
		{
			title: 'Add node to search',
			action: function (elm, d, i) {
				$("#constraint_field").val('{"path": "mlp_text.text", "type": "fact_str_val"}');

				var has_field = false;
				$('span[id^=selected_field_]').each(function (index) {
					if ($(this).text().includes(['[fact_text_values]'])) {
						has_field = true;
					}
				});
				if (!has_field) {
					add_field("", "", "");
				}

				var split_id = $('input[name^=fact_txt_]').last().attr('id').split('_');
				var suggestion_id = split_id[split_id.length - 2] + '_' + split_id[split_id.length - 1]
				if (has_field) {
					addFactValueFieldConstraint(split_id[split_id.length - 2], $("#fact_field_" + split_id[split_id.length - 2]).val())
					var split_id = $('input[name^=fact_txt_]').last().attr('id').split('_');
					var suggestion_id = split_id[split_id.length - 2] + '_' + split_id[split_id.length - 1]
				}

				$('#field_' + split_id[split_id.length - 2] + " #fact_txt_" + suggestion_id).val(elm["name"])
				$('#fact_constraint_op_' + suggestion_id).val('=');
				$("#fact_constraint_val_" + suggestion_id).val(elm["id"]);

			}
		},
		{
			title: 'Hide facts with this type',
			action: function (elm, d, i) {
				hideBy(name=elm['name'])
			}
		}
	]

	var hideBy;

	var graph = JSON.parse('{{graph_data|safe}}');

	function callGraph() {
		var linkedByIndex = {};
		graph.links.forEach(function (d) {
			linkedByIndex[d.source + "," + d.target] = true;
		});

		function isConnected(a, b) {
			return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
		}

		function hasConnections(a) {
			for (var property in linkedByIndex) {
				s = property.split(",");
				if ((s[0] == a.index || s[1] == a.index) && linkedByIndex[property]) return true;
			}
			return false;
		}

		force
			.nodes(graph.nodes)
			.links(graph.links)
			.start();

		var link = g.selectAll(".link")
			.data(graph.links)
			.enter().append("line")
			.attr("class", "link")

			.style("stroke-width", function (d) { return Math.pow(link_size(d.count) || nominal_stroke, 1); })

			.style("stroke", function (d) {
				if (isNumber(d.score) && d.score >= 0) return color(d.score);
				else return default_link_color;
			})


		var node = g.selectAll(".node")
			.data(graph.nodes)
			.enter().append("g")
			.attr("class", "node")
			.call(force.drag)
			.on('contextmenu', d3.contextMenu(menu));

		node.on("dblclick.zoom", function (d) {
			d3.event.stopPropagation();
			var dcx = (window.innerWidth / 2 - d.x * zoom.scale());
			var dcy = (window.innerHeight / 2 - d.y * zoom.scale());
			zoom.translate([dcx, dcy]);
			g.attr("transform", "translate(" + dcx + "," + dcy + ")scale(" + zoom.scale() + ")");
		});
		var tocolor = "fill";
		var towhite = "stroke";
		if (outline) {
			tocolor = "stroke"
			towhite = "fill"
		}

		var circle = node.append("path")
			.attr("d", d3.svg.symbol()
				.size(function (d) { return Math.PI * Math.pow(size(d.size) || nominal_base_node_size, 2); })
				.type(function (d) { return d.type; }))

			.style(tocolor, function (d) {
				if (shapes.indexOf(d.type) >= 0) return color(d.type);
				else return default_node_color;
			})
			.style("stroke-width", function (d) { return d.count; })
			.style(towhite, "white");


		var text = g.selectAll(".text")
			.data(graph.nodes)
			.enter().append("text")
			.attr("dy", ".35em")
			.style("font-size", nominal_text_size + "px")

		if (text_center)
			text.text(function (d) { return d.id; })
				.style("text-anchor", "middle");
		else
			text.attr("dx", function (d) { return (size(d.size) || nominal_base_node_size); })
				.text(function (d) { return '\u2002' + d.id; });

		node.on("mouseover", function (d) {
			set_highlight(d);
		})
			.on("mousedown", function (d) {
				d3.event.stopPropagation();
				focus_node = d;
				set_focus(d);
				set_highlight(d);
				if (highlight_node === null) set_highlight(d)

				selectedLegend(d, linkedByIndex, graph);
			}).on("mouseout", function (d) {
				exit_highlight();
			});

		d3.select(window).on("mousedown",
			function () {
				if (focus_node !== null) {
					focus_node = null;
					svg.select(".selectedSymbol")
						.attr("fill-opacity", 1).transition()
						.duration(300).attr("fill-opacity", 0).remove(); //remove after transitions are complete

					svg.select(".hiddenSelectedSymbol")
						.attr("fill-opacity", 1).transition()
						.duration(300).attr("fill-opacity", 0).remove()

					if (highlight_trans < 1) {
						circle.style("opacity", 0.7);
						text.style("opacity", 1);
						link.style("opacity", 0.5);
					}
				}

				if (highlight_node === null) exit_highlight();
			});

		function exit_highlight() {
			highlight_node = null;
			if (focus_node === null) {
				svg.style("cursor", "move");
				if (highlight_color != "white") {
					circle.style(towhite, "white");
					text.style("font-weight", "normal");
					link.style("stroke", function (o) { return (isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color });
				}
			}
		}

		function set_focus(d) {
			if (highlight_trans < 1) {
				circle.style("opacity", function (o) {
					return isConnected(d, o) ? 1 : highlight_trans;
				});

				text.style("opacity", function (o) {
					return isConnected(d, o) ? 1 : highlight_trans;
				});

				link.style("opacity", function (o) {
					return o.source.index == d.index || o.target.index == d.index ? 1 : highlight_trans;
				});
			}
		}


		function set_highlight(d) {
			svg.style("cursor", "pointer");
			if (focus_node !== null) d = focus_node;
			highlight_node = d;

			if (highlight_color != "white") {
				circle.style(towhite, function (o) {
					return isConnected(d, o) ? highlight_color : "white";
				});
				text.style("font-weight", function (o) {
					return isConnected(d, o) ? "bold" : "normal";
				});
				link.style("stroke", function (o) {
					return o.source.index == d.index || o.target.index == d.index ? highlight_color : ((isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color);

				});
			}
		}

		zoom.on("zoom", function () {

			var base_radius = nominal_base_node_size;
			if (nominal_base_node_size * zoom.scale() > max_base_node_size) base_radius = max_base_node_size / zoom.scale();
			circle.attr("d", d3.svg.symbol()
				.size(function (d) { return Math.PI * Math.pow(size(d.size) * base_radius / nominal_base_node_size || base_radius, 2); })
				.type(function (d) { return d.type; }))

			if (!text_center) text.attr("dx", function (d) { return (size(d.size) * base_radius / nominal_base_node_size || base_radius); });

			var text_size = nominal_text_size;
			if (nominal_text_size * zoom.scale() > max_text_size) text_size = max_text_size / zoom.scale();
			text.style("font-size", text_size + "px");

			g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
		});

		svg.call(zoom);

		resize();
		//window.focus();
		d3.select(window).on("resize", resize)//.on("keydown", keydown);

		force.on("tick", function () {

			node.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
			text.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

			link.attr("x1", function (d) { return d.source.x; })
				.attr("y1", function (d) { return d.source.y; })
				.attr("x2", function (d) { return d.target.x; })
				.attr("y2", function (d) { return d.target.y; });

			node.attr("cx", function (d) { return d.x; })
				.attr("cy", function (d) { return d.y; });
		});

		function resize() {
			var width = window.innerWidth, height = window.innerHeight;
			svg.attr("width", width).attr("height", height);

			force.size([force.size()[0] + (width - w) / zoom.scale(), force.size()[1] + (height - h) / zoom.scale()]).resume();
			w = width;
			h = height;
		}

		hideBy = function (name=null) {
			if (name) {
				factNamesShow[name] = !factNamesShow[name]
			}

			link.style("display", function (d) {
				var flag = factNamesShow[d.source.name] && factNamesShow[d.target.name] && vis_by_node_score(d.source.score) && vis_by_node_score(d.target.score);
				linkedByIndex[d.source.index + "," + d.target.index] = flag;
				return flag ? "inline" : "none";
			});
			node.style("display", function (d) {
				return (true || hasConnections(d)) && factNamesShow[d.name] && vis_by_node_score(d.score) ? "inline" : "none";
			});
			text.style("display", function (d) {
				return (true || hasConnections(d)) && factNamesShow[d.name] && vis_by_node_score(d.score) ? "inline" : "none";
			});

			if (highlight_node !== null) {
				if ((true || hasConnections(highlight_node)) && factNamesShow[highlight_node.name] && vis_by_node_score(highlight_node.score)) {
					if (focus_node !== null) set_focus(focus_node);
					set_highlight(highlight_node);
				}
				else { exit_highlight(); }
			}

		}
	};
	callGraph();

	function vis_by_node_score(score) {
		if (isNumber(score)) {
			if (score >= $('#countSlider').data('slider').getValue()) {return true} else {return false}
		}
		return true;
	}

	function isNumber(n) {
		return !isNaN(parseFloat(n)) && isFinite(n);
	}

	/* ####################################### LEGEND ##################################### */


	var triangleU = d3.svg.symbol().type('triangle-up')(),
		circle = d3.svg.symbol().type('circle')(),
		cross = d3.svg.symbol().type('cross')(),
		diamond = d3.svg.symbol().type('diamond')(),
		triangleD = d3.svg.symbol().type('triangle-down')(),
		square = d3.svg.symbol().type('square')();

	var symbolScale = d3.scale.ordinal()
		.domain(factNames)
		.range([circle, cross, diamond, square, triangleD, triangleU]);

	var svg = d3.select("svg");

	// var clickedName = ''
	svg.append("g")
		.attr("class", "legendSymbol")
		.attr("transform", "translate(20, 20)");

	var legendPath = d3.legend.symbol()
		.scale(symbolScale)
		.orient("vertical")
		.title("Click on the fact type to hide/reveal it:")
		.on("cellclick", function (d) { hideBy(name=d); });

	svg.select(".legendSymbol")
		.call(legendPath);

	var colorScale = d3.scale.ordinal()
		.domain(factNames)
		.range(colors)

	svg.selectAll(".cell path").each(function (d) {
		d3.select(this).style("fill", colorScale(d))
	})

	/* ############################ SELECTION ######################### */

	function selectedLegend(node, linkedByIndex, graph) {
		var linkedNodes = [];
		for (var i = 0; i < graph.links.length; i++) {
			if (graph.links[i]["source"]["source"] == node.source) {
				if (!linkedNodes.includes(graph.links[i]["target"])) {
					linkedNodes.push({ "count": graph.links[i]["count"], "value": graph.links[i]["target"] })
				}
			}
			else if (graph.links[i]["target"]["source"] == node.source) {
				linkedNodes.push({ "count": graph.links[i]["count"], "value": graph.links[i]["source"] })
			}
		}
		//sort function
		function sortByCount(a,b) {
			if (a["count"] > b["count"])
				return -1;
			if (a["count"] < b["count"])
				return 1;
			return 0;
		}
		//max 35 cooccurances
		cooccDisplayCount = 34
		cooccCount = linkedNodes.length
		linkedNodes = linkedNodes.sort(sortByCount)
		hiddenNodes = linkedNodes.slice(cooccDisplayCount, linkedNodes.length)
		linkedNodes = linkedNodes.slice(0, cooccDisplayCount);
		cooccCount = cooccCount - linkedNodes.length

		domainList = []
		rangeList = []
		colorList = []
		for (var i = 0; i < linkedNodes.length; i++) {
			domainList.push(linkedNodes[i]["count"] + 'x ' + linkedNodes[i]["value"]["name"] + " - " + linkedNodes[i]["value"]["id"]);
			rangeList.push(d3.svg.symbol().type(linkedNodes[i]["value"]["type"])());
			colorList.push(shapesColors[linkedNodes[i]["value"]["type"]]);
		}

		//Hidden tooltip
		if (cooccCount > 0) {
		hiddenRangeList = []
		hiddenColorList = []
		hiddenNodes = hiddenNodes.slice(0, cooccDisplayCount)
		for (var i = 0; i < hiddenNodes.length; i++) {
			hiddenRangeList.push(d3.svg.symbol().type(hiddenNodes[i]["value"]["type"])());
			hiddenColorList.push(shapesColors[hiddenNodes[i]["value"]["type"]]);
			hiddenNodes[i] = hiddenNodes[i]["count"] + 'x ' + hiddenNodes[i]["value"]["name"] + " - " + hiddenNodes[i]["value"]["id"]; }

		domainList.push(cooccCount + " hidden.."); colorList.push('#000000');
		// if there are even more left over
		if ((cooccCount - cooccDisplayCount) > 0)  {
			hiddenNodes.push((cooccCount - cooccDisplayCount) + ' hidden..');  hiddenColorList.push('#000000');
		}}

		var selectedSymbol = d3.scale.ordinal()
			.domain(domainList).range(rangeList);

		svg.append("g")
			.attr("class", "selectedSymbol").attr("transform", "translate(20, 250)");

		var selectedPath = d3.legend.symbol()
			.scale(selectedSymbol)
			.orient("vertical")
			.title(node.name + ' - ' + node.id + ' x' + node.score)
			.on("cellover", function (e) { if (cooccCount > 0) {if (e.includes('hidden..')) {displayHiddenCooccNodes()}; }})
			.on("cellout", function (e) { if (cooccCount > 0) {if (e.includes('hidden..')) {svg.select(".hiddenSelectedSymbol")//.remove();
						.attr("fill-opacity", 1).transition()
						.duration(300).attr("fill-opacity", 0).remove(); }}});

		svg.select(".selectedSymbol").call(selectedPath);

		var colorScale = d3.scale.ordinal()
			.domain(domainList).range(colorList)

		svg.selectAll(".selectedSymbol path").each(function (d) {
			d3.select(this).style("fill", colorScale(d))
		})

		// FOR HIDDEN NODES
		function displayHiddenCooccNodes() {
			var selectedSymbol = d3.scale.ordinal().domain(hiddenNodes).range(hiddenRangeList);
			svg.append("g").attr("class", "hiddenSelectedSymbol").attr("transform", "translate(250, 250)");
			var selectedPath = d3.legend.symbol().scale(selectedSymbol).orient("vertical")
				.title('Hidden nodes');

			svg.select(".hiddenSelectedSymbol").call(selectedPath);
			var colorScale = d3.scale.ordinal().domain(hiddenNodes).range(hiddenColorList)
			svg.selectAll(".hiddenSelectedSymbol path").each(function (d) {
				d3.select(this).style("fill", colorScale(d))
			})
		}
	}

/* ######################### SLIDER ###################### */
$("#countSlider").change(function() {
    hideBy();
});

</script>